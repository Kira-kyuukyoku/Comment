{extends file="admin-layout.tpl"}

{block name="no-return-functions"}
{$admin_current_location = 'configuration'}
{/block}

{block name="page-title"}{intl l='Comments'}{/block}

{block name="check-module"}comment{/block}
{block name="check-access"}view{/block}

{block name="main-content"}

{include file="commons.html" scope="parent"}

<div class="comments">

    <div id="wrapper" class="container">

        <ul class="breadcrumb">
            <li><a href="{url path='/admin/home'}">{intl l="Home"}</a></li>
            <li><a href="{url path='/admin/comment/comments'}">{intl l="Comments"}</a></li>
        </ul>

        {hook name="comments.top" location="comments_top" }

        {if $error_message}
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-danger">
                    {$error_message}
                </div>
            </div>
        </div>
        {/if}

        <div class="row">
            <div class="col-md-12">
                <div class="general-block-decorator">
                    <form action="" method="">
                        <table class="table table-striped table-condensed table-left-aligned">
                            <caption>
                                {intl l="Comments management"}
                                {loop type="auth" name="can_create" role="ADMIN" module="comment" access="CREATE"}
                                <a class="btn btn-primary action-btn" title="{intl l='Add a new comment'}" href="#creation_dialog" data-toggle="modal">
                                    <span class="glyphicon glyphicon-plus-sign"></span>
                                </a>
                                {/loop}
                            </caption>
                            <thead>
                            <tr>
                                <th>{intl l="ID"}</th>
                                <th>{intl l="Author"}</th>
                                <th>{intl l="Comment"}</th>
                                <th>{intl l="Actions"}</th>
                            </tr>
                            </thead>
                            <tbody>
                            {loop type="comment" name="comment.list" backend_context="1"}
                            <tr>
                                <td>{$ID}</td>

                                {* Author *}
                                <td>
                                    {if $CUSTOMER_ID}
                                        {loop type="customer" name="customer" id="{$CUSTOMER_ID}" current="no" backend_context="1"}
                                        <a href="{url path='/admin/customer/update' customer_id=$CUSTOMER_ID}">
                                            <img src="http://www.gravatar.com/avatar/{$EMAIL|trim|strtolower|md5}?s=48" alt="" /><br>
                                            {$FIRSTNAME} {$LASTNAME}
                                        </a>
                                        {/loop}
                                        {elseloop rel="customer"}
                                        <em>{intl l="Unknow customer %id" id="{$CUSTOMER_ID}" }</em>
                                        {/elseloop}
                                    {else}
                                        <span class="label label-default">{intl l="not a customer"}</span><br>
                                        <a href="mailto:{$EMAIL}">
                                            <img src="http://www.gravatar.com/avatar/{$EMAIL|trim|strtolower|md5}?s=48" alt="" /><br>
                                            {$USERNAME}
                                        </a>
                                    {/if}
                                </td>

                                {* Comment *}
                                <td>
                                    <h4>{$TITLE}</h4>
                                    <p>{$CONTENT}</p>
                                    <ul class="list-inline">
                                        <li>{intl l="Posted: "} <strong>{format_date date={$CREATED} output="datetime"}</strong></li>
                                        <li>{intl l="rating: "} <strong>{$RATING}</strong></li>
                                        <li>{intl l="verified: "} <strong>{if $VERIFIED}{intl l='yes'}{else}{intl l='no'}{/if}</strong></li>
                                    </ul>
                                </td>

                                <td class="actions">
                                    <div class="btn-group dropdown dropdown-status">
                                        {loop type="auth" name="can_change" role="ADMIN" module="comment" access="UPDATE"}
                                        <a id="status-{$ID}" data-id="{$ID}" class="btn btn-xs btn-{$comment_status[{$STATUS}].css} dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            {$comment_status[{$STATUS}].label} <span class="caret"></span>
                                        </a>
                                        {/loop}
                                    </div>
                                    <hr class="invisible" />
                                    <div class="btn-group dropdown dropdown-status">
                                        {loop type="auth" name="can_change" role="ADMIN" module="comment" access="UPDATE"}
                                        <a class="btn btn-default btn-xs comment-change" data-id="{$ID}" title="{intl l='Change this comment'}">
                                            <span class="glyphicon glyphicon-edit"></span>
                                        </a>
                                        {/loop}
                                        {loop type="auth" name="can_change" role="ADMIN" module="comment" access="DELETE"}
                                        <a href="#delete_dialog" data-toggle="modal" data-id="{$ID}" class="btn btn-default btn-xs comment-delete" title="{intl l="Delete this comment"}">
                                        <span class="glyphicon glyphicon-trash"></span>
                                        </a>
                                        {/loop}
                                    </div>
                                </td>
                            </tr>
                            {/loop}
                            </tbody>
                        </table>

                    </form>

                </div>
            </div>

        </div>

        {hook name="languages.bottom" location="languages_bottom" }

    </div>
</div>

<div id="dropdown-status">
    <ul class="dropdown-menu" role="menu">
        <li><a href="#" class="change-status" data-status="0">{$comment_status[0].label}</a></li>
        <li><a href="#" class="change-status" data-status="1">{$comment_status[1].label}</a></li>
        <li><a href="#" class="change-status" data-status="2">{$comment_status[2].label}</a></li>
        <li><a href="#" class="change-status" data-status="3">{$comment_status[3].label}</a></li>
    </ul>
</div>

{*
{form name="thelia.lang.create"}


{* Capture the dialog body, to pass it to the generic dialog *}
{* todo create comment
{capture "creation_dialog"}

{/capture}

{include
    file = "includes/generic-create-dialog.html"

    dialog_id    = "creation_dialog"
    dialog_title = {intl l="Create a new comment"}
    dialog_body  = {$smarty.capture.creation_dialog nofilter}

    dialog_ok_label     = {intl l="Create this comment"}

    form_action        = {url path='/admin/configuration/comments/add'}
    form_enctype       = {form_enctype form=$form}
    form_error_message = $form_error_message
}
{/form}
*}

{* Delete confirmation dialog *}

{capture "delete_dialog"}
    <input type="hidden" name="comment_id" id="comment_delete_id" value="" />
    {hook name="comments.delete-form" location="comments_delete_form" }
{/capture}

{include
    file = "includes/generic-confirm-dialog.html"

    dialog_id       = "delete_dialog"
    dialog_title    = {intl l="Delete comment"}
    dialog_message  = {intl l="Do you really want to delete this comment ?"}

    form_action         = {token_url path='/admin/comment/delete'}
    form_content        = {$smarty.capture.delete_dialog nofilter}
    form_error_message  = $error_delete_message
}

<div id="comment-update-modal"></div>

<div class="modal fade" id="delete-failed" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content alert alert-block alert-danger ">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h2>{intl l="Error"}</h2>
            </div>
            <div class="modal-body">
                <strong>{intl l="Impossible to delete comment."} {intl l="Please contact your administrator or try later"}</strong>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="status-failed" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content alert alert-block alert-danger ">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h2>{intl l="Error"}</h2>
            </div>
            <div class="modal-body">
                <strong>{intl l="Impossible to change status."} {intl l="Please contact your administrator or try later"}</strong>
            </div>

        </div>
    </div>
</div>

{/block}

{block name="javascript-initialization"}

{javascripts file='assets/js/main.js'}
<script src="{$asset_url}"></script>
{/javascripts}

<script>

    var commentStatus = {$comment_status|json_encode nofilter};
    var commentConfig = {
        'delete': '{url path="/admin/module/comment/delete"}',
        'status': '{url path="/admin/module/comment/status"}'
    };

    {literal}
    $(document).ready(function(){

        var $statusMenu = $('#dropdown-status');

        $('.dropdown-toggle').on('click.bs.dropdown', function(e){

            var $btn = $(e.currentTarget),
                $parent = $btn.parent(),
                $menu = $parent.children('dropdown-menu'),
                $clonedMenu = null;

            if ($menu.length == 0) {
                // creating the menu
                $clonedMenu = $statusMenu.children().first().clone();
                $clonedMenu.find('a').data('id', $btn.data('id'));
                $clonedMenu.appendTo($parent);
            }
        });

        $('.dropdown-status').on('click', '.change-status', function(e){
            e.preventDefault();

            $trigger = $(e.currentTarget);
            console.log("trigger status change", $trigger.data('id'), $trigger.data('status'));

            $.ajax({
                type: "POST",
                dataType: 'json',
                data: {'id': $trigger.data('id'), 'status': $trigger.data('status')},
                url: commentConfig['status']
            }).done(function(data, textStatus, jqXHR){
                if (data.success) {
                    var status = commentStatus[data.data.status];
                    $('#status-' + data.data.id + ']')
                        .removeClass('btn-default btn-success btn-info btn-warning btn-danger')
                        .addClass('btn-' + status.css)
                        .html(status.label + ' <span class="caret"></span>')
                    ;
                } else {
                    $('#status-failed').modal('show');
                }
            }).fail(function(jqXHR, textStatus, errorThrown){
                $('#status-failed').modal('show');
            });

        });

        $(".comment-delete").click(function(){
            $("#comment_delete_id").val($(this).data("id"));
        });
    });
    {/literal}
</script>
{/block}

{block name="javascript-last-call"}
{hook name="languages.js" location="languages-js" }
{/block}